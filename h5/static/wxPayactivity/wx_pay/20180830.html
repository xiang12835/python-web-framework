<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="renderer" content="webkit">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
		<meta name="format-detection" content="telephone=no">
		<meta name="screen-orientation" content="portrait">
		<meta http-equiv="pragma" content="no-cache">
		<meta http-equiv="cache-control" content="no-cache">
		<meta name="Keywords" content="必胜公考">
		<meta name="Description" content="必胜公考·公考全程服务平台">
		<link rel="stylesheet" type="text/css" href="../css/bootstrap.css" />
		<title>2019国考申论大礼包</title>
		<style type="text/css">
			.w100 {
				width: 100%;
			}
			
			.topbtn {
				width: 100%;
				position: fixed;
				-webkit-box-orient: horizontal;
				-webkit-box-direction: normal;
				-ms-flex-direction: row;
				flex-direction: row;
				-ms-flex-wrap: nowrap;
				flex-wrap: nowrap;
				background-color: #fff;
				right: 0;
				bottom: 0;
				z-index: 800;
			}
			
			.ribtngm {
				border-radius: 0;
				background-color: #e37d28;
				width: 108px;
				height: 52px;
				line-height: 14px;
				font-family: PingFangSC-Semibold, Microsoft YaHei, Helvetica, Arial, sans-serif;
				font-weight: 700;
				font-size: 15px;
				color: #fff;
				border: 0 solid #ebeef5;
				cursor: pointer;
				white-space: nowrap;
				float: right;
				text-align: center;
			}
			
			.topbtnlab {
				font-size: 18px;
				color: #fab200;
				line-height: 46px;
				margin-left: 10px;
			}
			
			.hide {
				display: none;
			}
			
			.mask {
				position: fixed;
				width: 100%;
				height: 100%;
				top: 0;
				left: 0;
				background: rgba(0, 0, 0, .4);
				z-index: 99;
			}
			
			.mask>* {
				background: #fff;
				position: absolute;
			}
			
			.changingAddress .form {
				width: 100%;
				padding: 10px;
				margin: auto;
				top: 20%;
				left: 0;
				right: 0;
				border-radius: 5px;
			}
			
			.addresstitle {
				font-size: 20px;
				margin-bottom: 20px;
				margin-left: 11px;
			}
			
			.changingAddress .form dt {
				text-align: right;
				vertical-align: middle;
				float: left;
				font-size: 14px;
				color: #606266;
				line-height: 40px;
				padding: 0 12px 0 0;
				box-sizing: border-box;
			}
			
			.changingAddress .form dt {
				width: 15%;
				padding-right: 5px;
				white-space: nowrap;
			}
			
			.changingAddress .form dd,
			.changingAddress .form dt {
				display: inline-block;
				height: 36px;
				line-height: 36px;
				margin-bottom: 20px;
				margin-left: 10px;
			}
			
			.changingAddress .form dd {
				width: 70%;
			}
			
			.changingAddress .form input {
				border-radius: 4px;
				border: 1px solid #dcdfe6;
				box-sizing: border-box;
				color: #606266;
				display: inline-block;
				font-size: inherit;
				height: 40px;
				line-height: 1;
				outline: none;
				padding: 0 15px;
				width: 100%;
			}
			
			input,
			textarea,
			select,
			button {
				text-rendering: auto;
				color: initial;
				letter-spacing: normal;
				word-spacing: normal;
				text-transform: none;
				text-indent: 0px;
				text-shadow: none;
				display: inline-block;
				text-align: start;
				margin: 0em;
				font: 400 11px system-ui;
			}
			
			.changingAddress .form button {
				width: 160px;
				height: 36px;
				line-height: 36px;
				margin: 10px 30%;
				border-radius: 5px;
				background: #ffbc42;
				color: #fff;
				border: none;
				text-align: center;
			}
			
			input,
			textarea {
				-webkit-touch-callout: text;
				-webkit-user-select: text;
				line-height: normal;
			}
		</style>
		<script>
			var _hmt = _hmt || [];
			(function() {
				var hm = document.createElement("script");
				hm.src = "https://hm.baidu.com/hm.js?ee4433ce841f7d9c97fbc65c7ec66146";
				var s = document.getElementsByTagName("script")[0];
				s.parentNode.insertBefore(hm, s);
			})();
		</script>

	</head>

	<body>
		<div role="tabpanel" id="pane-0" aria-labelledby="tab-0" class="el-tab-pane" style="">
			<img src="../img/0830fm.jpg" class="w100" />
			<img src="../img/WechatIMG69.jpeg" class="w100" />
		</div>
		<div class="topbtn">
			<label class="topbtnlab">￥19.9</label>
			<button id="buy" class="ribtngm notbuy" onclick="buycourse()">立即购买</button>
		</div>
		<div class="mask changingAddress hide">
			<dl class="form">
				<div class="close"><i class="icon-close"></i></div>
				<div class="addresstitle">收货地址</div>
				<dt>收货人</dt>
				<dd><input id="contactName" type="text" name=""></dd> <br>
				<dt>电话</dt>
				<dd><input id="contactNumber" type="text" name=""></dd> <br>
				<dt>地址</dt>
				<dd><input id="contactAddress" type="textarea" name=""></dd>
				<br>
				<button id="saveaddress">保存</button>
			</dl>
		</div>
	</body>
	<script src="../js/jquery.js" type="text/javascript" charset="utf-8"></script>
	<script src="../js/bootstrap.js" type="text/javascript" charset="utf-8"></script>
	<script src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js" type="text/javascript"></script>
	<script src="../js/main.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
		$(function() {
			var app_id = '7';
			var wxopenid = getCookie('wxopenid');
			var access_code = getQueryString('code');

			console.log(location.href);
			console.log("access_code      " + access_code);
			console.log("wxopenid      " + wxopenid);
			if($.isEmptyObject(wxopenid)) {
				if($.isEmptyObject(access_code)) {
					var fromurl = location.href;
					var url = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx6457a8b0deb2c4e9&redirect_uri=' + encodeURIComponent(fromurl) + '&response_type=code&scope=snsapi_userinfo&state=STATE&connect_redirect=1#wechat_redirect';
					location.href = url;
				} else {
					//获取openid和userInfo
					getUserInfo(access_code, app_id);
				}
			}

			// 获得签名配置
			var fromurl = location.href;
			var base_url = "https://api.web.platform.winlesson.com/api/wxpub/get_signature?appId=wx6457a8b0deb2c4e9&pageUrl=" + encodeURIComponent(fromurl);
			$.ajax({
				type: "get",
				url: base_url,
				dataType: "json",
				success: function(res) {
					var Data = res.result;
					// config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，
					wx.config({
						debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
						appId: 'wx6457a8b0deb2c4e9', // 必填，公众号的唯一标识
						timestamp: Data.timestamp, // 必填，生成签名的时间戳
						nonceStr: Data.nonceStr, // 必填，生成签名的随机串
						signature: Data.signature, // 必填，签名，见附录1
						jsApiList: ['chooseWXPay'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
					});

				}
			});
		})

		function getUserInfo(access_token, app_id) {
			var urls = "https://api.web.platform.winlesson.com/api/wx/access/user?code=" + access_token + "&app_id=" + app_id;
			$.ajax({
				type: "POST",
				url: urls,
				dataType: "json",
				success: function(res) {
					console.log("=====获取用户信息=======");
					console.log(res);
					if(res.userinfo.openid != undefined) {
						setCookie('wxopenid', res.userinfo.openid);
					}
				}
			});
		}

		function buycourse() {
			var user_id = getCookie('user_id');
			if(user_id) {
				createorder(); // 生成订单
			} else {
				window.location.href = "../login/login.html";
			}
		}

		// 生成订单
		function createorder() {
			var user_id = getCookie('user_id');
			var course_id = '201808311620262471807373';
			var url = 'https://api.web.platform.winlesson.com/api/pay/order_id/create' + '?userid=' + user_id + '&productId=' + course_id + '&productType=1&from=gzh';
			$.ajax({
				type: "POST",
				url: url,
				dataType: "json",
				success: function(res) {
					if(res.code == 200) {
						$("#contactName").val(res.result.address_info.contactNumber);
						$("#contactAddress").val(res.result.address_info.contactAddress);
						$("#contactNumber").val(res.result.address_info.contactName);
						$(".changingAddress").removeClass('hide');
						$("#saveaddress").on('click', function() {		
							savechangeaddress(res.result.orderId, course_id);
						})
					} else {
						alert(msg);
					}
				}
			});
		}

		//上传地址
		function savechangeaddress(orderId, course_id) {
			var user_id = getCookie('user_id');
			var contactName = $("#contactName").val();
			var contactAddress = $("#contactAddress").val();
			var contactNumber = $("#contactNumber").val();
			if (contactName=='') {
				alert("请填写收货人姓名");
				return false;
			}
			if (contactAddress=='') {
				alert("请填写收货人地址");
				return false;
			}
			if (contactNumber=='') {
				alert("请填写收货人电话");
				return false;
			}
			var url = 'https://api.web.platform.winlesson.com/api/bskgk/order/address/add' + '?userid=' + user_id + '&orderId=' + orderId+ '&from=gzh' + '&contactAddress=' + contactAddress+ '&contactName=' + contactName+ '&contactNumber=' + contactNumber;
			$.ajax({
				type: "POST",
				url: url,
				dataType: "json",
				success: function(res) {
					if(res.code == 200) {
						$(".changingAddress").addClass('hide');
						cofirmOrder(orderId); // 确认支付
					} else {
						alert(msg);
					}

				}
			});
		}

		// 确认订单
		function cofirmOrder(orderId) {
			var user_id = getCookie('user_id');
			var url = 'https://api.web.platform.winlesson.com/api/pay/order/update' + '?userid=' + user_id + '&orderId=' + orderId + '&productType=1&from=gzh';
			$.ajax({
				type: "POST",
				url: url,
				dataType: "json",
				success: function(res) {
					if(res.code == 200) {
						requestPayment(orderId); //微信小程序签名 - ~
					} else {
						alert(res.msg);
					}
				}
			});
		}

		//微信小程序签名 - ~
		function requestPayment(orderId) {
			var good_name = '2019国考申论大礼包';
			var openid = getCookie('wxopenid');
			var url = 'https://api.web.platform.winlesson.com/api/live/gzh/h5/do/pay' + '?order_id=' + orderId + '&good_name=' + good_name + '&openid=' + openid;
			$.ajax({
				type: "POST",
				url: url,
				dataType: "json",
				success: function(res) {
					console.log(res);
					console.log(res.data);
					//微信支付 - ~
					doPay(res);
				}
			});
		}

		function doPay(obj) {
			console.log(obj.data.params);
			var params = obj.data.params;
			wx.ready(function() {
				//调起微信支付
				wx.chooseWXPay({
					//相关支付参数
					'timestamp': params.timeStamp,
					'nonceStr': params.nonceStr,
					'package': params.package,
					'signType': params.signType,
					'paySign': params.paySign,
					//小程序微信支付成功的回调通知
					'success': function(res) {
						// 支付成功后的回调函数
						if(res.errMsg == "chooseWXPay:ok") {
							//支付成功
							window.location.href = "../pages/20180830over.html";
						} else {
							alert(res.errMsg);
						}

					}
				});
			});
		}
	</script>

</html>